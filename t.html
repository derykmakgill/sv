<html lang="en"><head><meta charset="utf-8"><meta name="author" content="Matthew Miner (matthew@matthewminer.com)"><meta name="copyright" content="© 2020 Matthew Miner"><meta name="description" content="The scenario: you’re building a web app and want to hop on the Docker train (mixing metaphors like a champ), but fitting this hot new container tech into you..."><meta name="viewport" content="width=device-width, initial-scale=1"><title> Docker Dev Environment for Web App</title><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"><link rel="manifest" href="/manifest.json"><link rel="canonical" href="/2015/01/25/docker-dev-environment-for-web-app.html"><link type="application/atom+xml" rel="alternate" href="https://matthewminer.com/feed.xml" title="Matthew Miner"><style>html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,footer,header,nav,section{display:block}h1{font-size:2em;margin:0.67em 0}figcaption,figure,main{display:block}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace, monospace;font-size:1em}a{background-color:transparent;-webkit-text-decoration-skip:objects}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace, monospace;font-size:1em}dfn{font-style:italic}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}audio,video{display:inline-block}audio:not([controls]){display:none;height:0}img{border-style:none}svg:not(:root){overflow:hidden}button,input,optgroup,select,textarea{font-family:sans-serif;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,html [type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:0.35em 0.75em 0.625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{display:inline-block;vertical-align:baseline}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details,menu{display:block}summary{display:list-item}canvas{display:inline-block}template{display:none}[hidden]{display:none}.highlight .hll{background-color:#ffc}.highlight .c{color:#888}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{color:#008800;font-weight:bold}.highlight .ch{color:#888}.highlight .cm{color:#888}.highlight .cp{color:#cc0000;font-weight:bold}.highlight .cpf{color:#888}.highlight .c1{color:#888}.highlight .cs{color:#cc0000;font-weight:bold;background-color:#fff0f0}.highlight .gd{color:#000000;background-color:#fdd}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#333}.highlight .gi{color:#000000;background-color:#dfd}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#666}.highlight .gt{color:#a00}.highlight .kc{color:#008800;font-weight:bold}.highlight .kd{color:#008800;font-weight:bold}.highlight .kn{color:#008800;font-weight:bold}.highlight .kp{color:#080}.highlight .kr{color:#008800;font-weight:bold}.highlight .kt{color:#888888;font-weight:bold}.highlight .m{color:#0000DD;font-weight:bold}.highlight .s{color:#dd2200;background-color:#fff0f0}.highlight .na{color:#369}.highlight .nb{color:#038}.highlight .nc{color:#bb0066;font-weight:bold}.highlight .no{color:#003366;font-weight:bold}.highlight .nd{color:#555}.highlight .ne{color:#bb0066;font-weight:bold}.highlight .nf{color:#0066bb;font-weight:bold}.highlight .nl{color:#336699;font-style:italic}.highlight .nn{color:#bb0066;font-weight:bold}.highlight .py{color:#336699;font-weight:bold}.highlight .nt{color:#bb0066;font-weight:bold}.highlight .nv{color:#369}.highlight .ow{color:#080}.highlight .w{color:#bbb}.highlight .mb{color:#0000DD;font-weight:bold}.highlight .mf{color:#0000DD;font-weight:bold}.highlight .mh{color:#0000DD;font-weight:bold}.highlight .mi{color:#0000DD;font-weight:bold}.highlight .mo{color:#0000DD;font-weight:bold}.highlight .sa{color:#dd2200;background-color:#fff0f0}.highlight .sb{color:#dd2200;background-color:#fff0f0}.highlight .sc{color:#dd2200;background-color:#fff0f0}.highlight .dl{color:#dd2200;background-color:#fff0f0}.highlight .sd{color:#dd2200;background-color:#fff0f0}.highlight .s2{color:#dd2200;background-color:#fff0f0}.highlight .se{color:#0044dd;background-color:#fff0f0}.highlight .sh{color:#dd2200;background-color:#fff0f0}.highlight .si{color:#3333bb;background-color:#fff0f0}.highlight .sx{color:#22bb22;background-color:#f0fff0}.highlight .sr{color:#008800;background-color:#fff0ff}.highlight .s1{color:#dd2200;background-color:#fff0f0}.highlight .ss{color:#aa6600;background-color:#fff0f0}.highlight .bp{color:#038}.highlight .fm{color:#0066bb;font-weight:bold}.highlight .vc{color:#369}.highlight .vg{color:#d70}.highlight .vi{color:#33b}.highlight .vm{color:#369}.highlight .il{color:#0000DD;font-weight:bold}*,*::before,*::after{box-sizing:inherit}blockquote,dl,figure,form,h1,h2,h3,h4,h5,h6,ol,p,pre,table,ul{margin:2rem 0}a{color:#2980b9;text-decoration:none;border-bottom:1px solid #2980b9}a.image-link{border-bottom-width:0}a:hover{border-color:transparent;color:#20638f}a:visited{border-color:#8e44ad;color:#8e44ad}a:visited:hover{color:#703688}abbr,abbr[title]{text-decoration:none}article{margin-top:12rem}article header{margin-bottom:4rem}article header a,article header a:hover,article header a:visited,article header a:visited:hover{border-width:0;color:inherit}article header h1{font-size:3.2rem;margin-bottom:1rem}article header time{color:#999;font-size:1.6rem}article img{width:100%}body{background-color:#fff;color:#333;font-family:Palatino, "Palatino Linotype", "Palatino LT STD", "Book Antiqua", Georgia, serif;font-size:1.8rem;font-weight:400;line-height:1.5;margin:0 auto;max-width:700px;padding:4rem 20px}code{background-color:#eee;border-radius:0.2rem;padding:0.2rem 0.4rem;white-space:nowrap}code,kbd{font-family:Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:1.5rem}h1,h2,h3,h4,h5,h6{color:#000;font-weight:700;line-height:1.1}h2,h3,h4,h5,h6{font-size:2rem;margin-top:4rem}hr{border-color:#eee;border-style:solid;border-width:0.2rem 0 0 0;margin:4rem auto;padding:0}html{box-sizing:border-box;font-size:62.5%}iframe{border:none;display:block}img{max-width:100%}kbd{background-color:#fafbfc;border:solid 1px #c6cbd1;border-bottom-color:#959da5;border-radius:0.3rem;box-shadow:inset 0 -1px 0 #959da5;color:#444d56;display:inline-block;line-height:1.6rem;padding:0.3rem 0.5rem}pre{background-color:#eee;margin-left:-20px;margin-right:-20px;overflow-x:auto;padding:2rem 20px}pre code{display:block;padding:0;white-space:pre}section{margin-top:8rem}section li{margin-bottom:0.5rem}section ul{list-style-type:none;padding-left:0}small{font-size:1.4rem}sup a{border-width:0}ol,ul{padding-left:6rem}ul{list-style-type:square}video{max-width:100%}[role="banner"] a{border-bottom:2px solid #000;color:inherit;display:block;padding-bottom:2px}[role="banner"] a:hover{border-color:transparent;color:inherit}[role="banner"] h1{display:inline-block;font-size:1.8rem;margin:0;text-transform:uppercase}#about{-webkit-box-align:center;-moz-box-align:center;box-align:center;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;-o-align-items:center;align-items:center;-ms-flex-align:center;display:-webkit-box;display:-moz-box;display:box;display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-moz-box-pack:center;box-pack:center;-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;-o-justify-content:center;justify-content:center;-ms-flex-pack:center}#about img{border-radius:0.5rem;margin-right:2rem}#about li:last-child{margin-bottom:0}#about ul{margin:0}#blog li{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}#blog time{color:#333;font-size:1.6rem;margin-right:0.5rem;font-feature-settings:"tnum"}#blog ul{color:#2980b9}#social path{fill:#333}#social svg{height:2rem;margin-right:0.5rem;position:relative;width:2rem;vertical-align:text-bottom}#social .email svg{top:-1px}#social .github svg{top:-2px}#social .linkedin svg{top:-2px}#social .youtube svg{top:-1px}.footnotes{font-size:1.4rem;padding-left:2rem}.footnotes code{font-size:1.2rem}.footnotes li{margin-bottom:1rem}.footnotes li:last-child{margin-bottom:0}.return{border-width:0;margin-left:0.5em}.return::after{content:"\21a9"}.video{height:0;overflow:hidden;padding-bottom:56.25%;position:relative}.video iframe{height:100%;position:absolute;width:100%}@media (max-height: 700px){article{margin-top:6rem}body{padding-bottom:2rem;padding-top:2rem}section{margin-top:4rem}}@media (max-width: 550px){#about{-webkit-box-align:start;-moz-box-align:start;box-align:start;-webkit-align-items:start;-moz-align-items:start;-ms-align-items:start;-o-align-items:start;align-items:start;-ms-flex-align:start;-webkit-box-orient:vertical;-moz-box-orient:vertical;box-orient:vertical;-webkit-box-direction:normal;-moz-box-direction:normal;box-direction:normal;-webkit-flex-direction:column;-moz-flex-direction:column;flex-direction:column;-ms-flex-direction:column}#about img{margin-right:0;margin-bottom:2rem}} 
  
@media print{body{background-color:white;color:black}a{border-color:gray;color:gray}code{background-color:transparent}pre{background-color:transparent;border:1px solid lightgray}pre span{color:black !important}header[role="banner"]{margin-bottom:4rem}header[role="banner"] a{color:black}article header,main header{background-color:transparent}article header time,main header time{color:gray}article h1,article h2,article h3,article h4,article h5,article h6,main h1,main h2,main h3,main h4,main h5,main h6{background-color:transparent;color:black}main time{color:black}}</style><style type="text/css">
@font-face {
  font-family: 'Avenir Next CE';
  src: url("chrome-extension://facncfnojagdpibmijfjdmhkklabakgd/assets/fonts/AvenirNextLTW01-Medium/1a7c9181-cd24-4943-a9d9-d033189524e0.eot") format("eot"), url("chrome-extension://facncfnojagdpibmijfjdmhkklabakgd/assets/fonts/AvenirNextLTW01-Medium/f26faddb-86cc-4477-a253-1e1287684336.woff") format("woff"), url("chrome-extension://facncfnojagdpibmijfjdmhkklabakgd/assets/fonts/AvenirNextLTW01-Medium/63a74598-733c-4d0c-bd91-b01bffcd6e69.ttf") format("ttf"), url("chrome-extension://facncfnojagdpibmijfjdmhkklabakgd/assets/fonts/AvenirNextLTW01-Medium/627fbb5a-3bae-4cd9-b617-2f923e29d55e.woff2") format("woff2");
}
@font-face {
  font-family: 'Avenir Next CE';
  font-weight: 600;
  src: url("chrome-extension://facncfnojagdpibmijfjdmhkklabakgd/assets/fonts/AvenirNextLTW01-Demi/12d643f2-3899-49d5-a85b-ff430f5fad15.eot") format("eot"), url("chrome-extension://facncfnojagdpibmijfjdmhkklabakgd/assets/fonts/AvenirNextLTW01-Demi/91b50bbb-9aa1-4d54-9159-ec6f19d14a7c.woff") format("woff"), url("chrome-extension://facncfnojagdpibmijfjdmhkklabakgd/assets/fonts/AvenirNextLTW01-Demi/a0f4c2f9-8a42-4786-ad00-fce42b57b148.ttf") format("ttf"), url("chrome-extension://facncfnojagdpibmijfjdmhkklabakgd/assets/fonts/AvenirNextLTW01-Demi/aad99a1f-7917-4dd6-bbb5-b07cedbff64f.woff2") format("woff2");
}
</style></head><body data-gr-c-s-loaded="true"><header role="banner"><h1> <a href="/" title="Home">Deryk Makgill</a></h1></header><article><header><h1> <a href="/2015/01/25/docker-dev-environment-for-web-app.html"> Docker Dev Environment for Web App </a></h1><time datetime="2015-01-25"> January 25, 2015 </time></header><p>The scenario: you’re building a web app and want to hop on the Docker train (mixing metaphors like a champ), but fitting this hot new container tech into your development workflow has you flummoxed. Your dev environment should mirror production’s as closely as possible, so running your app from a Docker container in both is a smart choice. Unfortunately, at least at first glance, this sacrifices the convenience of running the app from your local file system.</p><p>The good news is that with some initial setup, and not much at that, you can rock a dev environment almost identical to production without losing niceties like auto-reload and isolation from your host system.</p><p>In this tutorial we build a <a href="http://flask.pocoo.org">Flask</a> web app using <a href="http://gunicorn.org">Gunicorn</a> as our HTTP server. This makes these instructions a tad Python-centric, but the main ideas (and there’s only a few of them, no biggie) are applicable to other languages and frameworks.</p><h2 id="the-web-app">The Web App</h2><p>Our web app is comprised of five files.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── Dockerfile
├── app.py
├── fig.yml
├── gunicorn.py
└── requirements.txt
</code></pre></div></div><h3 id="requirementstxt">requirements.txt</h3><p>This file specifies the Python packages to install. We only need two: Flask and Gunicorn.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># requirements.txt
flask==0.10.1
gunicorn==19.1.1
</code></pre></div></div><h3 id="apppy">app.py</h3><p>Nothing special here, just a bare bones web app that prints “Hello World” when we visit the root.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app.py
</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'Hello World!'</span>
</code></pre></div></div><h3 id="gunicornpy">gunicorn.py</h3><p>Instead of passing the <code class="language-plaintext highlighter-rouge">gunicorn</code> binary a buttload of command line arguments, we load its configuration settings from a separate file. We can stick any logic we want in here, which will be useful later. For now it contains a single option telling Gunicorn the host and port to run on.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># gunicorn.py
</span><span class="n">bind</span> <span class="o">=</span> <span class="s">'0.0.0.0:80'</span>
</code></pre></div></div><h3 id="dockerfile">Dockerfile</h3><p>And now the file that Docker uses to build an image.</p><div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Dockerfile</span>
<span class="k">FROM</span><span class="s"> python:3.4-onbuild</span>
<span class="k">EXPOSE</span><span class="s"> 80</span>
<span class="k">CMD</span><span class="s"> ["gunicorn", "--config=gunicorn.py", "app:app"]</span>
</code></pre></div></div><p>There’s surprisingly little happening in this file. The first line indicates the base image to use, in this case one from the official repositories available at the <a href="https://registry.hub.docker.com">Docker Hub Registry</a>. The next line tells Docker to expose port 80, i.e. the port that Gunicorn runs the server on. The final line specifies the command to run when the container starts.</p><h4 id="-onbuild">-onbuild</h4><p>Several of the official Docker base images have a useful -onbuild variant. <a href="https://github.com/docker-library/python/blob/e236058d5c3601af1d38ba27b4fe217c5d678c02/3.4/onbuild/Dockerfile">The one we’re using</a>, in addition to installing Python and Pip in the image, also copies our source code to the <em>/usr/src/app/</em> directory and installs packages listed in <em>requirements.txt</em>. It’s a minor convenience, but it saves some boilerplate from our <em>Dockerfile</em>. There’s -onbuild variants for <a href="https://registry.hub.docker.com/_/node/">Node.js</a>, <a href="https://registry.hub.docker.com/_/ruby/">Ruby</a>, and <a href="https://registry.hub.docker.com/_/golang/">Go</a> also. Highly recommended.</p><h2 id="fire-it-up">Fire It Up</h2><p>All the pieces are in place. See the app in action by running the following commands then navigating to http://localhost:8080.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">--tag</span><span class="o">=</span>mminer/myserver <span class="nb">.</span>
docker run <span class="nt">-it</span> <span class="nt">--publish</span><span class="o">=</span>8080:80 mminer/myserver
</code></pre></div></div><p>If all goes well your browser displays “Hello World!” as expected. Brilliant.</p><p>At this point we can push the image to the Docker Hub (or a private registry) and deploy it live. However, we have a problem: when we update our code, our changes aren’t reflected by the running server without another build + run. Fast though the build process is thanks to Docker’s caching, re-running these steps becomes tedious quickly.</p><h2 id="autoreload">Autoreload</h2><p>Whenever we modify a file, the server should detect this and restart itself, showing our changes immediately. Flask’s development server in debug mode (<code class="language-plaintext highlighter-rouge">app.run(debug=True)</code>) does this, as can many production-ready servers like Gunicorn.</p><p>So we need to tell Gunicorn whether we’re in development or production mode. Perhaps the easiest method is by using environment variables. Docker allows us to specify environment variables both in our <em>Dockerfile</em> or at runtime as arguments to <code class="language-plaintext highlighter-rouge">docker run</code>. The latter option is what we want.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-it</span> <span class="nt">--publish</span><span class="o">=</span>8080:80 <span class="nt">--env</span><span class="o">=</span><span class="s2">"MODE=dev"</span> mminer/myserver
</code></pre></div></div><p>Let’s modify our <em>gunicorn.py</em> configuration file to turn on the reload option when the <code class="language-plaintext highlighter-rouge">MODE</code> environment variable equals “dev”.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># gunicorn.py
</span><span class="kn">import</span> <span class="nn">os</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'MODE'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'dev'</span><span class="p">:</span>
    <span class="nb">reload</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">bind</span> <span class="o">=</span> <span class="s">'0.0.0.0:80'</span>
</code></pre></div></div><p>Now whenever a file changes, Gunicorn relaunches its workers and loads our new code.</p><h2 id="synced-folders">Synced Folders</h2><p>With one last piece of the puzzle we’ll have everything working nicely. When we build the Docker image, our source files are copied to its <em>/usr/src/app</em> directory. Luckily Docker offers a way to share directories between a host and a container. For those familiar with Vagrant, this is akin to their synced folders feature. If the directory that we’re mapping already exists in the container, ours overwrites it. When we update a file the change is immediately reflected inside the container.</p><p>Specify the directory to share by providing <code class="language-plaintext highlighter-rouge">docker run</code> with a <code class="language-plaintext highlighter-rouge">--volume</code> argument.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-it</span> <span class="nt">--publish</span><span class="o">=</span>8080:80 <span class="nt">--env</span><span class="o">=</span><span class="s2">"MODE=dev"</span> <span class="nt">--volume</span><span class="o">=</span>/path/to/app:/usr/src/app:ro mminer/myserver
</code></pre></div></div><p>And voila! Edit the source code on your host machine using your favourite editor and the server detects the changes and reloads itself. If you save syntax errors and the server shuts down when it can’t decipher your typos, simply re-run the above command to be back in action lickety-split.</p><h2 id="fig">Fig</h2><p>Before we wrap up, allow me to tell you about <a href="http://www.fig.sh">Fig</a> (<a href="https://github.com/docker/fig/issues/861">soon to be Docker Compose</a>). The <code class="language-plaintext highlighter-rouge">docker run</code> command above is a bit gnarly and only worsens as your app grows in complexity. Specifying the command line arguments in a configuration file makes life more pleasant, which is what Fig allows you to do. Sure, you can just chuck the command into a Bash script and call it a day, but as you start working with multiple containers (say, one for your app and another for a database), orchestration becomes painful. Fig makes this headache disappear.</p><p>Our configuration file looks like this.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fig.yml</span>
<span class="na">myserver</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">8080:80"</span>
    <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">MODE=dev</span>
    <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">.:/usr/src/app:ro</span>
</code></pre></div></div><p>Instead of <code class="language-plaintext highlighter-rouge">docker run</code>, use <code class="language-plaintext highlighter-rouge">fig up</code> to start your container (<a href="http://www.fig.sh/cli.html">full list of commands here</a>). Nice.</p><h2 id="wrapping-up">Wrapping Up</h2><p>There you have it, a lightweight, isolated, auto-reloading web server running inside a Docker container, the image of which can be deployed to production with no modification. Keep on rocking in the free world.</p><hr><p><small> Code snippets from this post <a href="https://github.com/mminer/blog-code/tree/master/docker-dev-environment-for-web-app">viewable on GitHub</a>. <br> Thanks to <a href="https://twitter.com/ppawiggers">@ppawiggers</a> for corrections. </small></p></article>
</body></html>
